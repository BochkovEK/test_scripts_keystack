# to string for tf: https://dadroit.com/yaml-to-string/
# description:
# - change pass for ubuntu user by echo -n "1111" | openssl passwd -6 -stdin
# - add dns servers (google)
# - install fio, jq
# !!! Note:
#  - After creating the VM, cloud-init may still be executing the configured commands.
#  - check log:
#       tail -f /var/log/cloud-init-output.log
#  - cloud-init status -> status: done
#  - View disk_check logs if FAIL
#       journalctl -u disk_check.service -f --since "5 min ago"
#  - View disk_check logs if OK
#       tail -f /var/log/disk_check.log

# ----------------------- CUT TO PAST START -----------------------

#cloud-config
chpasswd:
  expire: false
  users:
    - name: ubuntu
      password: "$6$1RIJCwfWrd3WqaPd$sKcB5WNabsMQmCl3mu1JwJUsyrgNJdux5Ahj/6e1o79RRIyDwCjjEh44lqbo18T3lmOxfHuzlXpTwfvebO7S61"
      type: hash
ssh_pwauth: true

write_files:
  - path: /etc/systemd/resolved.conf
    content: |
      [Resolve]
      DNS=8.8.8.8 8.8.4.4 77.88.8.8
      FallbackDNS=1.1.1.1
      Domains=~.

runcmd:
  - echo "Custom cloud-init commands started executing..." >> /var/log/cloud-init-output.log
  - systemctl restart systemd-resolved
  - |
    for i in {1..6}; do
      apt-get update && apt-get install -y iperf3 && break || sleep 10
    done
  - systemctl daemon-reload
  - systemctl start disk_check.service
  - systemctl enable disk_check.service
  - echo "Custom cloud initialization commands completed!" >> /var/log/cloud-init-output.log

# ----------------------- CUT TO PAST END -----------------------

#  - systemctl enable systemd-resolved
#  - ln -sf /run/systemd/resolve/resolv.conf /etc/resolv.conf
